#!/bin/sh

clear; echo 'Running Alpine Labs flashloader' ;
echo 'Listening for Pulse connections via USB' ;
echo '' ;

while true;
	python /home/pi/alpine_utilities/pulse-LED.py 0.1 &
	sleep 0.1;
	do if lsusb | grep Freescale >/dev/null; then
		sleep 1;
		python /home/pi/alpine_utilities/pulse-LED.py 15 &
		if ls /media/pi/ | grep Pulse; then
			echo 'Pulse was mounted correctly'
		else
			echo 'Mounting Pulse...'
			sudo mkdir /media/pi/Pulse;
			sudo mount -t vfat /dev/sd* /media/pi/Pulse;
		fi;

		echo 'Copying Firmware to Pulse. Please Wait...';
		cp /home/pi/alpine_utilities/pulse-firmware.sb /media/pi/Pulse/;
		sleep 15;
		echo 'Done Copying. You may now remove Pulse.';

		while lsusb | grep Freescale >/dev/null;
			do echo 'Please remove Pulse to continue.';
			sleep 1;
		done;

		sudo rm -rf /media/pi/Pulse;
		echo ''
		echo 'Resuming scan for Pulse'
	fi;
done
